# OmniThink 大纲格式错误修复

## 问题描述

用户反馈 Grok 在使用 OmniThink 框架时输出了错误的 Markdown 格式：

```markdown
###4. 大纲生成
- # 青狮营2.0：律师AI进化营
- ## Why: AI时代律师痛点与机遇
- ## How:3核心课程实战路径
### ###1.打破AI信息壁垒
### ###2.最小阻力写作运营
### ###3.口语化AI编程
- ## Unique Edge: 自研工具+8年黑客
- ## Warnings & Metrics
- ##行动：2026，一起进化
```

## 错误分析

### 1. **列表中嵌套标题**（严重错误）
```markdown
- # 青狮营2.0：律师AI进化营        ❌ 列表项中不能放标题
- ## Why: AI时代律师痛点与机遇      ❌ 列表项中不能放标题
```

**问题**：Markdown 渲染引擎无法正确解析列表项中的标题，导致：
- 标题失去语义层级
- 渲染为普通文本，无法生成 TOC（目录）
- 视觉层级混乱

### 2. **重复标题符号**（语法错误）
```markdown
### ###1.打破AI信息壁垒             ❌ ### 重复了两次
### ###2.最小阻力写作运营           ❌ ### 重复了两次
```

**问题**：
- 第一个 `###` 创建了一个标题元素
- 第二个 `###` 被当作标题内容的一部分
- 渲染结果：`<h3>###1.打破AI信息壁垒</h3>`（错误）

### 3. **标题缺少空格**（格式错误）
```markdown
- ##行动：2026，一起进化            ❌ ## 后面缺少空格
```

**问题**：虽然前端有预处理修复，但源头就应避免

### 4. **混合使用列表和标题**（结构错误）
```markdown
- ## How:3核心课程实战路径          ❌ 列表项
### ###1.打破AI信息壁垒             ❌ 突然变成标题
```

**问题**：破坏了文档的结构完整性，读者无法理解层级关系

## 根本原因

OmniThink 框架 Prompt 中的第 4 步要求：

> **4. 大纲生成：极简大纲（3-7层标题）。**

但**没有明确说明**：
- 应该使用纯 Markdown 标题语法
- 禁止在列表中嵌套标题
- 禁止重复标题符号

导致 AI 模型自行"创造"了一种**语义上是大纲，但语法上错误**的混合结构。

## 解决方案

### 修改位置
`app/jobs/llm_stream_job.rb` - `get_framework_prompt('omnithink')`

### 修改内容

**之前**（第 184 行）：
```ruby
4. 大纲生成：极简大纲（3-7层标题）。
```

**现在**（第 184-199 行）：
```ruby
4. 大纲生成：极简大纲（3-7层标题）
   
   ⚠️ 【大纲格式要求 - 必须严格遵守】
   - 使用纯 Markdown 标题语法：`#`、`##`、`###`（每级标题独立成行）
   - ❌ 禁止：在列表项中嵌套标题（如 `- # 标题`）
   - ❌ 禁止：重复标题符号（如 `### ###1. 标题`）
   - ❌ 禁止：混用列表和标题（如 `- ## How` 后接 `### ###1`）
   - ✅ 正确示例：
     ```
     # 主标题
     ## 二级标题
     ### 三级标题
     ### 三级标题2
     ## 二级标题2
     ```
   - ✅ 如需缩进层级，用多级标题（`##`、`###`、`####`），不用列表符号
```

## 正确的大纲格式

### 示例 1：纯标题结构（推荐）
```markdown
# 青狮营2.0：律师AI进化营

## Why: AI时代律师痛点与机遇

## How: 3核心课程实战路径

### 1. 打破AI信息壁垒

### 2. 最小阻力写作运营

### 3. 口语化AI编程

## Unique Edge: 自研工具+8年黑客

## Warnings & Metrics

## 行动：2026，一起进化
```

**渲染效果**：✅ 完美
- 标题层级清晰
- 可自动生成 TOC
- 视觉效果专业

### 示例 2：标题 + 内容（也可以）
```markdown
# 青狮营2.0：律师AI进化营

## Why: AI时代律师痛点与机遇

律师行业 AI 采用率低于 20%，远低于科技行业...

## How: 3核心课程实战路径

### 1. 打破AI信息壁垒

掌握 Claude、o1 等开发大模型...

### 2. 最小阻力写作运营

自研工具 + 黑客增长公式...
```

**渲染效果**：✅ 完美
- 标题与内容分离
- 层级结构清晰

## 错误示例对比

### ❌ 错误方式 1：列表嵌套标题
```markdown
- # 主标题
  - ## 二级标题
    - ### 三级标题
```

**问题**：
- 标题失去语义
- 无法生成 TOC
- 渲染为列表项，不是标题

### ❌ 错误方式 2：重复符号
```markdown
### ###1. 标题
### ###2. 标题
```

**渲染结果**：
```html
<h3>###1. 标题</h3>
<h3>###2. 标题</h3>
```

**问题**：第二个 `###` 被当作文本内容

### ❌ 错误方式 3：混合结构
```markdown
- ## How: 方法
### ###1. 步骤一
### ###2. 步骤二
```

**问题**：结构混乱，无法理解层级关系

## 技术实现

### 1. Prompt 层面（源头控制）✅

**位置**：`app/jobs/llm_stream_job.rb` - Line 184-199

**作用**：
- 明确告诉 AI 模型正确的 Markdown 语法
- 提供正确和错误的示例对比
- 使用警告符号（⚠️、❌、✅）强调重要性

### 2. 前端预处理（防御层）✅

**位置**：`app/javascript/controllers/articles_controller.ts`

**作用**：
- 即使 AI 输出错误格式，前端也会自动修复
- 修复标题、列表、表格的空格问题
- 但**无法修复**列表嵌套标题的结构性错误

**局限**：
```javascript
// 可以修复
"###标题"  → "### 标题"  ✅

// 无法修复
"- # 标题"  →  仍然是错误结构  ❌
```

### 3. 为什么必须在 Prompt 中修复

**前端预处理的局限性**：
- 正则表达式无法理解语义（区分"列表中的标题"和"正常标题"）
- 如果强行转换 `- # 标题` → `# 标题`，会破坏用户真正想要列表的情况
- 结构性错误需要从源头（AI 生成）避免

## 测试验证

### 测试步骤
1. 启动项目：`bin/dev`
2. 访问 `/write` 页面
3. 选择 **OmniThink 写作引擎** 框架
4. 输入任意文本并点击"开始脑爆"
5. 观察 Grok 输出的"###4. 大纲生成"部分

### 预期结果

**之前**：
```markdown
###4. 大纲生成
- # 青狮营2.0：律师AI进化营
- ## Why: AI时代律师痛点与机遇
### ###1.打破AI信息壁垒
```
❌ 渲染混乱，无法正确显示标题

**现在**：
```markdown
### 4. 大纲生成

# 青狮营2.0：律师AI进化营
## Why: AI时代律师痛点与机遇
### 1. 打破AI信息壁垒
```
✅ 完美渲染，标题层级清晰

## 影响范围

- **框架**：OmniThink 写作引擎
- **模型**：所有使用该框架的 AI 模型（Grok、Qwen、DeepSeek、Gemini、智谱、豆包、ChatGPT）
- **阶段**：AI 脑爆阶段（Step 2）

## 相关文档

- [Markdown 格式规范强制要求](./markdown_format_requirements.md) - 整体 Markdown 修复方案
- [UTF-8 流式响应修复](./utf8_streaming_fix.md) - 字符边界问题
- [Markdown 流式渲染修复](./markdown_streaming_fix.md) - 不完整 markdown 处理

## 总结

通过在 OmniThink 框架 Prompt 中**明确禁止错误的 Markdown 语法，并提供正确示例**，从根本上解决了大纲生成时的格式混乱问题：

1. ✅ 禁止列表中嵌套标题（`- # 标题`）
2. ✅ 禁止重复标题符号（`### ###1. 标题`）
3. ✅ 提供正确的纯标题结构示例
4. ✅ 强调使用多级标题（`##`、`###`、`####`）而非列表符号表示层级
5. ✅ 配合前端预处理和通用 Markdown 规范，形成三重防御

---

**最后更新**：2025-01-17  
**问题状态**：✅ 已修复  
**修改文件**：`app/jobs/llm_stream_job.rb`（+19 行，-3 行）
