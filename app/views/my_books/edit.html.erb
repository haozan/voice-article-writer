<% content_for :title, "编辑书籍 - #{@book.title}" %>

<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 dark:from-gray-900 dark:to-gray-800 py-8">
  <div class="container-xl mx-auto px-4">
    
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-50 flex items-center gap-3 mb-2">
            <%= lucide_icon "book-open", class: "w-8 h-8" %>
            编辑书籍
          </h1>
          <p class="text-gray-600 dark:text-gray-400"><%= @book.title %></p>
        </div>
        
        <div class="flex gap-2">
          <%= link_to my_book_path(@book), class: "btn-primary" do %>
            <%= lucide_icon "book-open", class: "w-5 h-5 mr-2" %>
            阅读
          <% end %>
          <%= link_to my_books_path, class: "btn-ghost" do %>
            <%= lucide_icon "arrow-left", class: "w-5 h-5 mr-2" %>
            返回列表
          <% end %>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Left: Book Info Form -->
      <div class="lg:col-span-2">
        <div class="card bg-white dark:bg-gray-800 shadow-lg">
          <div class="card-body p-6">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4">基本信息</h2>
            
            <%= form_with model: @book, url: my_book_path(@book), method: :patch, class: "space-y-5" do |f| %>
              
              <!-- Title -->
              <div>
                <%= f.label :title, "书籍标题", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
                <%= f.text_field :title, 
                    class: "form-input w-full #{'border-red-500' if @book.errors[:title].any?}" %>
                <% if @book.errors[:title].any? %>
                  <p class="text-red-500 text-sm mt-1"><%= @book.errors[:title].first %></p>
                <% end %>
              </div>

              <!-- Subtitle -->
              <div>
                <%= f.label :subtitle, "副标题", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
                <%= f.text_field :subtitle, class: "form-input w-full" %>
              </div>

              <!-- Author -->
              <div>
                <%= f.label :author, "作者", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
                <%= f.text_field :author, class: "form-input w-full" %>
              </div>

              <!-- Description -->
              <div>
                <%= f.label :description, "书籍简介", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
                <%= f.text_area :description, rows: 4, class: "form-input w-full" %>
              </div>

              <!-- Cover Style -->
              <div>
                <%= f.label :cover_style, "封面风格", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3" %>
                <div class="grid grid-cols-3 md:grid-cols-5 gap-3">
                  <% Book::COVER_STYLES.each do |style, name| %>
                    <label class="relative cursor-pointer">
                      <%= f.radio_button :cover_style, style, class: "peer sr-only" %>
                      <div class="card border-2 border-gray-300 peer-checked:border-primary peer-checked:bg-primary/5 transition-all hover:border-primary/50 text-center p-2">
                        <div class="aspect-[3/4] bg-gradient-to-br <%= case style
                          when 'minimal' then 'from-gray-600 to-gray-800'
                          when 'gradient' then 'from-blue-500 to-purple-600'
                          when 'literary' then 'from-amber-600 to-orange-700'
                          when 'modern' then 'from-teal-500 to-cyan-600'
                          when 'academic' then 'from-gray-100 to-gray-200 border border-gray-400'
                        end %> rounded mb-2"></div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300"><%= name %></span>
                      </div>
                    </label>
                  <% end %>
                </div>
              </div>

              <!-- Status & Pinned -->
              <div class="flex gap-6">
                <div class="flex-1">
                  <%= f.label :status, "发布状态", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
                  <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer">
                      <%= f.radio_button :status, 'draft', class: "form-radio" %>
                      <span class="ml-2 text-gray-700 dark:text-gray-300">草稿</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                      <%= f.radio_button :status, 'published', class: "form-radio" %>
                      <span class="ml-2 text-gray-700 dark:text-gray-300">已发布</span>
                    </label>
                  </div>
                </div>
                
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">&nbsp;</label>
                  <label class="flex items-center cursor-pointer">
                    <%= f.check_box :pinned, class: "form-checkbox" %>
                    <span class="ml-2 text-gray-700 dark:text-gray-300">置顶显示</span>
                  </label>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-3 pt-4">
                <%= link_to my_books_path, class: "btn-ghost flex-1" do %>
                  <%= lucide_icon "arrow-left", class: "w-5 h-5 mr-2" %>
                  返回列表
                <% end %>
                <%= f.submit "保存更改", class: "btn-primary flex-1" %>
              </div>

            <% end %>
          </div>
        </div>
      </div>

      <!-- Right: Chapter Management -->
      <div class="lg:col-span-1">
        <div class="card bg-white dark:bg-gray-800 shadow-lg sticky top-8">
          <div class="card-body p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50">章节管理</h2>
              <button type="button" 
                      onclick="document.getElementById('newChapterModal').classList.remove('hidden')"
                      class="btn-primary btn-sm">
                <%= lucide_icon "plus", class: "w-4 h-4 mr-1" %>
                新增
              </button>
            </div>
            
            <% if @book.chapters.any? %>
              <div class="space-y-2 max-h-[600px] overflow-y-auto">
                <%= render partial: 'my_books/chapter_tree', locals: { chapters: @book.root_chapters } %>
              </div>
            <% else %>
              <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <%= lucide_icon "folder-open", class: "w-12 h-12 mx-auto mb-3 opacity-50" %>
                <p class="text-sm">还没有章节</p>
                <p class="text-xs mt-1">点击上方"新增"按钮创建章节</p>
              </div>
            <% end %>
            
            <!-- Stats -->
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold text-primary"><%= @book.chapters.count %></div>
                  <div class="text-xs text-gray-600 dark:text-gray-400">章节数</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-primary"><%= @book.articles_count %></div>
                  <div class="text-xs text-gray-600 dark:text-gray-400">文章数</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- New Chapter Modal -->
<div id="newChapterModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="card bg-white dark:bg-gray-800 max-w-lg w-full">
    <div class="card-body p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-50">新建章节</h3>
        <button type="button" 
                onclick="document.getElementById('newChapterModal').classList.add('hidden')"
                class="btn-ghost p-2">
          <%= lucide_icon "x", class: "w-5 h-5" %>
        </button>
      </div>
      
      <%= form_with url: my_book_chapters_path(@book), method: :post, class: "space-y-4" do |f| %>
        <%= f.hidden_field :book_id, value: @book.id, disabled: true %>
        
        <div>
          <%= f.label :title, "章节标题", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
          <%= f.text_field :title, 
              placeholder: "例如：第一章 基础知识",
              class: "form-input w-full",
              required: true %>
        </div>
        
        <div>
          <%= f.label :parent_id, "父章节（可选）", class: "block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" %>
          <%= f.select :parent_id, 
              options_for_select([['无（作为顶级章节）', '']] + @book.chapters.map { |c| [c.full_title, c.id] }),
              {},
              class: "form-select w-full" %>
          <p class="text-xs text-gray-500 mt-1">选择父章节可以创建子章节</p>
        </div>
        
        <div class="flex gap-3 pt-4">
          <button type="button" 
                  onclick="document.getElementById('newChapterModal').classList.add('hidden')"
                  class="btn-ghost flex-1">
            取消
          </button>
          <%= f.submit "创建章节", class: "btn-primary flex-1" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
