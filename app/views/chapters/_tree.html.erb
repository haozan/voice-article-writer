<% chapters.each do |chapter| %>
  <div class="chapter-item">
    <!-- Chapter Title -->
    <div class="flex items-start gap-2 py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer group"
         data-action="click->book-reader#loadChapter"
         data-chapter-id="<%= chapter.id %>">
      
      <!-- Expand/Collapse Icon (if has sub-chapters or articles) -->
      <% if chapter.sub_chapters.any? || chapter.articles.any? %>
        <button class="flex-shrink-0 w-5 h-5 flex items-center justify-center"
                data-action="click->book-reader#toggleChapter:stop"
                data-chapter-id="<%= chapter.id %>">
          <%= lucide_icon "chevron-right", class: "w-4 h-4 text-gray-500 transition-transform", 
                          data: { chapter_toggle: chapter.id } %>
        </button>
      <% else %>
        <div class="w-5 h-5"></div>
      <% end %>

      <!-- Chapter Info -->
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2">
          <%= lucide_icon "folder", class: "w-4 h-4 text-blue-500 flex-shrink-0" %>
          <span class="font-medium text-gray-900 dark:text-gray-50 text-sm truncate">
            <%= chapter.title %>
          </span>
        </div>
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          <%= chapter.articles.count %> 篇文章
        </div>
      </div>
    </div>

    <!-- Sub-items (sub-chapters and articles) -->
    <% if chapter.sub_chapters.any? || chapter.articles.any? %>
      <div class="ml-6 hidden" data-chapter-content="<%= chapter.id %>">
        <!-- Sub-chapters -->
        <% if chapter.sub_chapters.any? %>
          <%= render partial: 'chapters/tree', locals: { chapters: chapter.sub_chapters.order(:position) } %>
        <% end %>

        <!-- Articles in this chapter -->
        <% chapter.articles.order(:position).each do |article| %>
          <div class="flex items-start gap-2 py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors cursor-pointer"
               data-action="click->book-reader#loadArticle"
               data-article-id="<%= article.id %>">
            <%= lucide_icon "file-text", class: "w-4 h-4 text-green-500 flex-shrink-0 mt-0.5" %>
            <div class="flex-1 min-w-0">
              <span class="text-sm text-gray-700 dark:text-gray-300 truncate block">
                <%= article.final_content.present? ? article.final_content.truncate(30) : "文章 ##{article.id}" %>
              </span>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                <%= article.created_at.strftime('%Y-%m-%d') %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
